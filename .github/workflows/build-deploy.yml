name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build application
        run: npm run build

      - name: Prepare production dependencies
        run: |
          # Remove dev dependencies and install only production deps
          rm -rf node_modules
          npm ci --omit=dev
          # Create a production package.json without dev dependencies
          node -e "const pkg=require('./package.json'); delete pkg.devDependencies; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2))"
          # Remove unnecessary files
          rm -rf .git* .prettier* .eslint* tests/ src/

      - name: Create deployment archive
        run: |
          tar czf deployment.tar.gz build/ node_modules/ package.json package-lock.json start.sh
          echo "Created deployment archive with only necessary files"

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: deployment.tar.gz
          retention-days: 5
